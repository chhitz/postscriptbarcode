From cf38e80b416913ebcc24f451c94d06de64c33629 Mon Sep 17 00:00:00 2001
From: Christian Hitz <christian@klarinett.li>
Date: Sun, 2 Sep 2012 13:58:14 +0200
Subject: [PATCH] implement matrix codes with paths

---
 barcode.ps             | 42 ++++++++++++++++++++----------------------
 barcode_with_sample.ps | 44 +++++++++++++++++++++-----------------------
 2 Dateien geändert, 41 Zeilen hinzugefügt(+), 45 Zeilen entfernt(-)

diff --git a/barcode.ps b/barcode.ps
index 96f3b4a..d5935d7 100644
--- a/barcode.ps
+++ b/barcode.ps
@@ -305,7 +305,7 @@ begin
     % Default options
     /width 1 def
     /height 1 def
-    /color (unset) def
+    /barcolor (unset) def
     /backgroundcolor (unset) def
 
     % Apply the renderer options and the user options
@@ -314,25 +314,9 @@ begin
 
     /width width cvr def
     /height height cvr def
-    /color color cvlit def
+    /barcolor barcolor cvlit def
     /backgroundcolor backgroundcolor cvlit def
 
-    % Extend bitmap horizontally to an 8-bit boundary
-    /pixx8 pixx 8 div ceiling cvi 8 mul def
-    /pixs8 [ pixx8 pixy mul {0} repeat ] def
-    0 1 pixy 1 sub {
-        /i exch def
-        pixs8 pixx8 i mul pixs pixx i mul pixx getinterval putinterval
-    } for
-    /pixs pixs8 def
-
-    % Convert bitmap into 8-bit sample string
-    /imgstr pixs length 8 idiv string def
-    0 1 pixs length 1 sub {
-        /i exch def
-        imgstr i 8 idiv 2 copy get 2 7 i 8 mod sub exp cvi pixs i get mul add put
-    } for
-
     % Set RGB or CMYK color depending on length of given hex string
     /setanycolor {
         /anycolor exch def
@@ -347,11 +331,25 @@ begin
     % Draw the image
     gsave
     currentpoint translate
-    72 width mul 72 height mul scale
-    .0001 .0001 moveto .9999 .0001 lineto .9999 .9999 lineto .0001 .9999 lineto closepath
+    width pixx div 72 mul height pixy div 72 mul scale
+    0 0 moveto pixx 0 lineto pixx pixy lineto 0 pixy lineto closepath
     backgroundcolor (unset) ne { gsave backgroundcolor setanycolor fill grestore } if 
-    color (unset) ne { color setanycolor } if
-    pixx pixy true [ pixx 0 0 pixy neg 0 pixy ] {imgstr} imagemask
+    barcolor (unset) ne { barcolor setanycolor } if
+    /i 0 def
+    pixs {
+	/x i pixx mod def
+	/y pixy 1 sub i pixx idiv sub def
+	1 eq {
+	    newpath
+	    x y moveto
+	    1 0 rlineto
+	    0 1 rlineto
+	    -1 0 rlineto
+	    0 -1 rlineto
+	    closepath fill
+	} if
+	/i i 1 add def
+    } forall
     grestore
 
     end
diff --git a/barcode_with_sample.ps b/barcode_with_sample.ps
index 827c8fe..4250d9c 100644
--- a/barcode_with_sample.ps
+++ b/barcode_with_sample.ps
@@ -305,7 +305,7 @@ begin
     % Default options
     /width 1 def
     /height 1 def
-    /color (unset) def
+    /barcolor (unset) def
     /backgroundcolor (unset) def
 
     % Apply the renderer options and the user options
@@ -314,25 +314,9 @@ begin
 
     /width width cvr def
     /height height cvr def
-    /color color cvlit def
+    /barcolor barcolor cvlit def
     /backgroundcolor backgroundcolor cvlit def
 
-    % Extend bitmap horizontally to an 8-bit boundary
-    /pixx8 pixx 8 div ceiling cvi 8 mul def
-    /pixs8 [ pixx8 pixy mul {0} repeat ] def
-    0 1 pixy 1 sub {
-        /i exch def
-        pixs8 pixx8 i mul pixs pixx i mul pixx getinterval putinterval
-    } for
-    /pixs pixs8 def
-
-    % Convert bitmap into 8-bit sample string
-    /imgstr pixs length 8 idiv string def
-    0 1 pixs length 1 sub {
-        /i exch def
-        imgstr i 8 idiv 2 copy get 2 7 i 8 mod sub exp cvi pixs i get mul add put
-    } for
-
     % Set RGB or CMYK color depending on length of given hex string
     /setanycolor {
         /anycolor exch def
@@ -347,11 +331,25 @@ begin
     % Draw the image
     gsave
     currentpoint translate
-    72 width mul 72 height mul scale
-    .0001 .0001 moveto .9999 .0001 lineto .9999 .9999 lineto .0001 .9999 lineto closepath
+    width pixx div 72 mul height pixy div 72 mul scale
+    0 0 moveto pixx 0 lineto pixx pixy lineto 0 pixy lineto closepath
     backgroundcolor (unset) ne { gsave backgroundcolor setanycolor fill grestore } if 
-    color (unset) ne { color setanycolor } if
-    pixx pixy true [ pixx 0 0 pixy neg 0 pixy ] {imgstr} imagemask
+    barcolor (unset) ne { barcolor setanycolor } if
+    /i 0 def
+    pixs {
+	/x i pixx mod def
+	/y pixy 1 sub i pixx idiv sub def
+	1 eq {
+	    newpath
+	    x y moveto
+	    1 0 rlineto
+	    0 1 rlineto
+	    -1 0 rlineto
+	    0 -1 rlineto
+	    closepath fill
+	} if
+	/i i 1 add def
+    } forall
     grestore
 
     end
@@ -17442,7 +17440,7 @@ end
 483 300 moveto ([\)>^03001^02996152382802^029840^029001^0291Z00004951^029UPSN^02906X610^029159^0291234567^0291/1^029^029Y^029634 ALPHA DR^029PITTSBURGH^029PA^029^004) (mode=2 parse) /maxicode /uk.co.terryburton.bwipp findresource exec
 0 -10 rmoveto (MaxiCode) show
 
-245 190 moveto (This is PDF417) (columns=2 color=442222 backgroundcolor=AABBCC) /pdf417 /uk.co.terryburton.bwipp findresource exec
+245 190 moveto (This is PDF417) (columns=2 barcolor=442222 backgroundcolor=AABBCC) /pdf417 /uk.co.terryburton.bwipp findresource exec
 0 -10 rmoveto (PDF417) show
 
 300 600 moveto (http://www.terryburton.co.uk/barcodewriter/) (rows=48 columns=48) /datamatrix /uk.co.terryburton.bwipp findresource exec
-- 
1.7.11.5

